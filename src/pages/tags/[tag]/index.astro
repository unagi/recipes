---
import path from 'node:path';
import type { ImageMetadata } from 'astro';
import BaseHead from '../../../components/BaseHead.astro';
import Footer from '../../../components/Footer.astro';
import Header from '../../../components/Header.astro';
import { Image } from 'astro:assets';
import { getCollection, type CollectionEntry } from 'astro:content';
import { SITE_TITLE } from '../../../consts';
import { formatPrepTime, formatCookingTime } from '../../../utils/format';

export async function getStaticPaths() {
	const recipes = await getCollection('recipes');
	const tagSet = new Set<string>();

	recipes.forEach((recipe) => {
		recipe.data.tags.forEach((tag) => {
			tagSet.add(tag);
		});
	});

	return Array.from(tagSet).map((tag) => {
		const filteredRecipes = recipes.filter((recipe) => recipe.data.tags.includes(tag));
		return {
			params: { tag },
			props: { recipes: filteredRecipes, tagLabel: tag },
		};
	});
}

type Props = {
	recipes: Awaited<ReturnType<typeof getCollection<'recipes'>>>;
	tagLabel: string;
};

const { recipes, tagLabel } = Astro.props;
const sortedRecipes = [...recipes].sort(
	(a, b) => b.data.publishedDate.valueOf() - a.data.publishedDate.valueOf()
);
const recipeImageModules = import.meta.glob<{ default: ImageMetadata }>(
	'/src/content/recipes/**/*.{png,jpg,jpeg,webp,avif}'
);

// 同名の画像ファイルを自動検出
const resolveRecipeImage = async (entry: CollectionEntry<'recipes'>) => {
	if (!entry.filePath) {
		return undefined;
	}

	const entryDir = path.posix.dirname(`/${entry.filePath}`);
	const baseName = path.posix.basename(entry.filePath, '.md');

	// 対応する拡張子を優先順に試行
	const extensions = ['png', 'jpg', 'jpeg', 'webp', 'avif'];

	for (const ext of extensions) {
		const imagePath = path.posix.join(entryDir, `${baseName}.${ext}`);
		const loader = recipeImageModules[imagePath];
		if (loader) {
			const module = await loader();
			return module.default;
		}
	}

	return undefined;
};

const recipesWithImages = await Promise.all(
	sortedRecipes.map(async (recipe) => ({
		recipe,
		image: await resolveRecipeImage(recipe),
	}))
);
---

<!doctype html>
<html lang="ja">
	<head>
		<BaseHead
			title={`${tagLabel}レシピ一覧 | ${SITE_TITLE}`}
			description={`${tagLabel}のレシピ一覧です。詳細ページから材料と手順を確認できます。`}
		/>
	</head>
	<body>
		<Header />
		<main>
			<section class="hero">
				<p class="kicker">レシピ共有サイト</p>
				<h1>{tagLabel}レシピ一覧</h1>
				<p>{tagLabel}のレシピ一覧です。詳細ページから材料と手順を確認できます。</p>
			</section>

			<section>
				<ul class="recipe-list">
					{recipesWithImages.map(({ recipe, image }) => {
						const displayTags = recipe.data.tags.slice(0, 3);
						const hasPrepTime = recipe.data.prepTime && recipe.data.prepTime > 0;
						const hasCookTime = recipe.data.cookTime && recipe.data.cookTime > 0;
						const cardImage = image;

						return (
							<li class="recipe-card">
								<a href={`/recipes/${recipe.data.recipeId}/`} class="card-link">
									{cardImage ? (
										<Image
											src={cardImage}
											alt={`${recipe.data.title}の写真`}
											class="card-image"
											width={600}
											height={400}
										/>
									) : (
										<div class="card-image placeholder" aria-hidden="true">
											<span class="material-icons">photo</span>
										</div>
									)}
									<h3>{recipe.data.title}</h3>
									<p class="description">{recipe.data.description}</p>
									<div class="recipe-meta">
										{hasPrepTime && (
											<div class="meta-item">
												<span class="material-icons">schedule</span>
												<span>準備: {formatPrepTime(recipe.data.prepTime!)}</span>
											</div>
										)}
										{hasCookTime && (
											<div class="meta-item">
												<span class="material-icons">timer</span>
												<span>調理: {formatCookingTime(recipe.data.cookTime!)}</span>
											</div>
										)}
										{recipe.data.servings && (
											<div class="meta-item">
												<span class="material-icons">people</span>
												<span>{recipe.data.servings}人分</span>
											</div>
										)}
									</div>
								</a>
								{displayTags.length > 0 && (
									<ul class="tag-list">
										{displayTags.map((tag) => (
											<li>
												<a class="tag-link" href={`/tags/${encodeURIComponent(tag)}/`}>
													{tag}
												</a>
											</li>
										))}
									</ul>
								)}
							</li>
						);
					})}
				</ul>
			</section>
		</main>
		<Footer />
	</body>
</html>

<style>
	.hero {
		margin-bottom: 3rem;
	}
	.kicker {
		text-transform: uppercase;
		letter-spacing: 0.1em;
		font-size: 0.9rem;
		color: rgb(var(--gray));
	}
	.recipe-list {
		list-style: none;
		padding: 0;
		margin: 0 0 2rem;
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
		gap: 2rem;
	}
	.recipe-card {
		display: flex;
		flex-direction: column;
		background: white;
		border-radius: 16px;
		box-shadow: var(--box-shadow);
		transition: transform 0.2s ease, box-shadow 0.3s ease;
		overflow: hidden;
	}
	.recipe-card:hover {
		transform: translateY(-4px);
		box-shadow: 0 4px 16px rgba(var(--gray), 25%), 0 12px 28px rgba(var(--gray), 30%);
	}
	.card-link {
		flex: 1;
		display: block;
		padding: 1.75rem 1.75rem 1rem;
		text-decoration: none;
		color: inherit;
	}
	.card-image {
		width: 100%;
		height: auto;
		aspect-ratio: 3 / 2;
		object-fit: cover;
		border-radius: 12px;
		margin-bottom: 1rem;
		display: block;
	}
	.card-image.placeholder {
		display: grid;
		place-items: center;
		background: linear-gradient(135deg, rgba(var(--gray-light), 0.9), rgba(var(--accent), 0.15));
		border: 1px solid rgba(var(--gray), 0.2);
		color: rgba(var(--gray-dark), 0.6);
	}
	.card-image.placeholder .material-icons {
		font-size: 32px;
	}
	.recipe-card h3 {
		margin-bottom: 0.75rem;
		font-size: 1.5rem;
		color: rgb(var(--black));
	}
	.description {
		margin-bottom: 1.25rem;
		color: rgb(var(--gray));
		line-height: 1.5;
		font-size: 0.95rem;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
	.recipe-meta {
		display: flex;
		flex-wrap: wrap;
		gap: 1rem;
		margin-bottom: 1rem;
		padding-top: 0.5rem;
		border-top: 1px solid rgb(var(--gray-light));
	}
	.meta-item {
		display: flex;
		align-items: center;
		gap: 0.4rem;
		font-size: 0.9rem;
		color: rgb(var(--gray-dark));
	}
	.meta-item .material-icons {
		font-size: 18px;
		color: rgb(var(--accent));
	}
	.tag-list {
		list-style: none;
		padding: 0 1.75rem 1.5rem;
		margin: auto 0 0;
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
	}
	.tag-list li {
		background: rgb(var(--gray-light));
		border-radius: 999px;
		display: flex;
		align-items: center;
	}
	.tag-link {
		display: flex;
		align-items: center;
		line-height: 1;
		padding: 0.35rem 0.75rem;
		font-size: 0.8rem;
		color: rgb(var(--gray-dark));
		text-decoration: none;
	}
	.tag-link:hover {
		color: rgb(var(--accent));
	}
	@media (max-width: 720px) {
		.recipe-list {
			grid-template-columns: 1fr;
			gap: 1.5rem;
		}
	}
</style>
